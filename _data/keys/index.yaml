---
- key: pg.index.discovery
  description: >
    Returns a JSON array of all known PostgreSQL indexes for databases which
    are accessible to the connected user.
  type: Discovery
  parameters:
    - parameter: search mode
      description: >
        search all accessible databases (`deep`) or only the connected database
        (`shallow`)
      default: "`deep`"
    - parameter: schema
      description: filter by parent schema
    - parameter: table
      description: filter by parent table
  example: pg.index.discovery[,my_db,public,my_table]
  macros: 
    - macro: "{#OID}"
      description: Index unique identifier
    - macro: "{#INDEX}"
      description: Index name
    - macro: "{#TABLE}`"
      description: Parent table of the index
    - macro: "{#DATABASE}"
      description: Parent database of the index
    - macro: "{#SCHEMA}"
      description: Parent namespace of the index
    - macro: "{#OWNER}"
      description: Owner name
    - macro: "{#ACCESS}"
      description: Index access method (e.g. `btree`, `hash`, `gin`, etc.)
  source: >
    SELECT
      ic.oid AS oid
      , ic.relname AS index
      , current_database() AS database
      , n.nspname AS schema
      , t.relname AS table
      , a.rolname AS owner
      , m.amname AS access
    FROM pg_index i
    JOIN pg_class ic ON ic.oid = i.indexrelid
    JOIN pg_namespace n ON n.oid = ic.relnamespace
    JOIN pg_roles a ON a.oid = ic.relowner
    JOIN pg_class t ON t.oid = i.indrelid
    JOIN pg_am m ON m.oid = ic.relam
    WHERE
      n.nspname <> 'pg_catalog'
      AND n.nspname <> 'information_schema'
      AND n.nspname !~ '^pg_toast'
      AND ...

- key: pg.index.size
  description: >
    Returns the size in bytes of a PostgreSQL Index. If no index is specified,
    the sum size of all indexes in the connected databse is returned.
  type: Numeric (unsigned)
  parameters:
    - parameter: index
      description: >
        The name or OID of the desired Index. If not specified, the sum size of
        all accessible indexes is returned

  units: B
  example: pg.index.size[,,ix_my_index]
  source: >
    SELECT
      relpages::bigint * 8192
    FROM pg_class
    WHERE
      relkind='i'
      AND relname = $1

- key: pg.index.rows
  description: >
    Returns the estimated row count of a PostgreSQL Index. If no index is
    specified, the sum count of all indexes in the connected databse is
    returned.
  type: Numeric (unsigned)
  parameters:
    - parameter: index
      description: >
        The name or OID of the desired Index. If not specified, the sum count
        of all accessible indexes is returned

  units: B
  example: pg.index.rows[,,ix_my_index]
  source: >
    SELECT
      reltuples
    FROM pg_class
    WHERE
      relkind='i'
      AND relname = $1

- key: pg.index.idx_scan
  description: Number of index scans initiated on this index
  type: Numeric (unsigned)
  parameters:
    - parameter: index
      description: >
        The name or OID of the desired Index. If not specified, the sum count
        of all accessible indexes is returned
  example: pg.index.idx_scan[,,ix_my_index]
  source: SELECT idx_scan FROM pg_stat_all_indexes WHERE indexrelname = $1

- key: pg.index.idx_tup_read
  description: Number of index entries returned by scans on this index
  type: Numeric (unsigned)
  parameters:
    - parameter: index
      description: >
        The name or OID of the desired Index. If not specified, the sum count
        of all accessible indexes is returned
  example: pg.index.idx_tup_read[,,ix_my_index]
  source: SELECT idx_tup_read FROM pg_stat_all_indexes WHERE indexrelname = $1

- key: pg.index.idx_tup_fetch
  description: Number of live table rows fetched by simple index scans using this index
  type: Numeric (unsigned)
  parameters:
    - parameter: index
      description: >
        The name or OID of the desired Index. If not specified, the sum count
        of all accessible indexes is returned
  example: pg.index.idx_tup_fetch[,,ix_my_index]
  source: SELECT idx_tup_fetch FROM pg_stat_all_indexes WHERE indexrelname = $1

- key: pg.index.idx_blks_read
  description: Number of disk blocks read from this index
  parameters:
    - parameter: index
      description: >
        The name or OID of the desired Index. If not specified, the sum count
        of all accessible indexes is returned
  example: pg.index.idx_blks_read[,,ix_my_index]
  source: SELECT idx_blks_read FROM pg_statio_all_indexes WHERE indexrelname = $1

- key: pg.index.idx_blks_hit
  description: Number of buffer hits in this index
  parameters:
    - parameter: index
      description: >
        The name or OID of the desired Index. If not specified, the sum count
        of all accessible indexes is returned
  example: pg.index.idx_blks_read[,,ix_my_index]
  source: SELECT idx_blks_hit FROM pg_statio_all_indexes WHERE indexrelname = $1
